stages:
  - build
  - push

variables:
    # 置空则使用当前日期
    VERSION:  "debug"
    # 置空则为amd64
    ARCH: "all"
    # 没啥用的变量
    MESSAGE: "中文支持1"
    # ----常量----
    IMAGE_NAME: "karthrand/flasktest"
    CONTAINER_NAME: "flasktest"
    test_except_str: Success

build_job:
  stage: build
  tags:
    - docker
  variables:
    GIT_DEPTH: "1"
  rules:
    # 仅在当前分支提交时message包含"镜像构建"时触发
    - if: '$CI_COMMIT_MESSAGE =~ /镜像构建/'
      when: on_success
    - when: never
  script:
    - |
      if [ -z "$VERSION" ]; then
        export VERSION=$(date +%Y%m%d)
        echo "当前默认版本为：$VERSION"
      else
        echo "手动设置版本为： $VERSION"
      fi
      if [ -z "$ARCH" ]; then
        export ARCH="amd64"
        echo "当前默认架构为：$ARCH"
      else
        echo "手动设置架构为： $ARCH"
      fi
      if [ ${ARCH} == "all" ]; then
          echo "构建AMD镜像: $IMAGE_NAME:$VERSION-amd64"
          echo "----------------------------------------"
          docker build -t $IMAGE_NAME:$VERSION-amd64 --build-arg ARCH=amd64 .
          echo "----------------------------------------"
          echo "构建ARM镜像: $IMAGE_NAME:$VERSION-arm64"
          docker buildx build --platform linux/arm64 -t $IMAGE_NAME:$VERSION-arm64  --build-arg ARCH=arm64 .
      elif [ ${ARCH} == "arm64" ]; then
          echo "构建ARM镜像: $IMAGE_NAME:$VERSION-arm64"
          docker buildx build --platform linux/arm64 -t $IMAGE_NAME:$VERSION-arm64  --build-arg ARCH=arm64 .
      else
          echo "构建AMD镜像: $IMAGE_NAME:$VERSION-amd64"
          docker build -t $IMAGE_NAME:$VERSION-amd64 --build-arg ARCH=amd64 .
      fi
      echo "export VERSION=$VERSION" > env.sh
      echo "export ARCH=$ARCH" >> env.sh
  artifacts:
    paths:
      - env.sh
    expire_in: 5 minutes 

push_job:
  stage: push
  tags:
    - docker
  dependencies:
    - build_job
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /镜像构建/'
      when: on_success
    - when: never
  script:
    - |
      source env.sh
      echo "当前镜像版本为：$VERSION"
      echo "当前镜像架构为：$ARCH"
      echo "登录Dockerhub"
      echo $DOCKERHUB_PASSWORD | docker login --username $DOCKERHUB_USER --password-stdin

      func_amd64(){
          echo "上传: $IMAGE_NAME:$VERSION-amd64"
          docker push $IMAGE_NAME:$VERSION-amd64
      }

      func_arm64(){
          echo "上传: $IMAGE_NAME:$VERSION-arm64"
          docker push $IMAGE_NAME:$VERSION-arm64
      }

      func_mix(){
          echo "上传双架构镜像：$IMAGE_NAME:$VERSION"
          docker manifest create  $IMAGE_NAME:$VERSION --amend $IMAGE_NAME:$VERSION-amd64 --amend $IMAGE_NAME:$VERSION-arm64
          docker manifest push $IMAGE_NAME:$VERSION 

          echo "上传双架构镜像：$IMAGE_NAME:latest"
          docker manifest create  $IMAGE_NAME:latest --amend $IMAGE_NAME:$VERSION-amd64 --amend $IMAGE_NAME:$VERSION-arm64
          docker manifest push $IMAGE_NAME:latest 
      }
      if [ ${ARCH} == "all" ]; then
          func_amd64
          func_arm64
          func_mix
      elif [ ${ARCH} == "arm64" ]; then
          func_arm64
      else
          func_amd64
      fi
